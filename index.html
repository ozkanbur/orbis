<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orman Veri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼ (Pro Stil)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        .drop-zone { 
            border: 2px dashed #198754; 
            padding: 40px; 
            border-radius: 15px; 
            background: #f8fff9; 
            cursor: pointer; 
            transition: 0.3s; 
        }
        /* Hem mouse ile Ã¼zerine gelince hem de dosya sÃ¼rÃ¼kleyince (dragover) aynÄ± efekti veriyoruz */
        .drop-zone:hover, .drop-zone.dragover { 
            background: #eafbe7; 
            border-color: #146c43; 
            transform: scale(1.01); 
        }
        .log-entry { margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid #eee; font-size: 13px; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: 0.15em; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ðŸŒ² Orman Depo - Pro DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼</h5>
                    <span class="badge bg-white text-success">v3.2 (Drag&Drop)</span>
                </div>
                <div class="card-body p-4">
                    <p class="text-center text-muted mb-4">
                        Excel dosyalarÄ±nÄ±zÄ± yÃ¼kleyin. Sistem:<br>
                        1. <b>Tertemiz Liste:</b> Ä°stif, Ã‡ap, Boy, Adet listesi oluÅŸturur. (Otomatik SayÄ± FormatÄ±)<br>
                        2. <b>Birebir Kopya:</b> Orijinal formun kenarlÄ±klarÄ± bozulmadan kopyasÄ±nÄ± alÄ±r.
                    </p>
                    
                    <div id="dropArea" class="drop-zone text-center mb-4" onclick="document.getElementById('fileInput').click()">
                        <div class="mb-2" style="font-size: 30px;">ðŸ“‚</div>
                        <h5 class="fw-bold text-success">DosyalarÄ± SeÃ§in veya SÃ¼rÃ¼kleyin</h5>
                        <p class="text-muted small">Ã‡oklu seÃ§im yapabilirsiniz (.xlsx, .xlsm)</p>
                        <input type="file" id="fileInput" multiple accept=".xlsx, .xls, .xlsm" style="display: none;" onchange="handleFiles(this.files)">
                    </div>

                    <div id="fileInfo" class="text-center mb-3 fw-bold text-dark" style="display:none;"></div>

                    <button id="processBtn" class="btn btn-primary btn-lg w-100 disabled" onclick="processFiles()">
                        ðŸš€ DÃ¶nÃ¼ÅŸtÃ¼rmeyi BaÅŸlat
                    </button>

                    <div class="mt-4">
                        <h6 class="text-muted">Ä°ÅŸlem KaydÄ±:</h6>
                        <div id="logArea" class="border rounded p-3 bg-white text-muted" style="height: 200px; overflow-y: auto; font-family: monospace;">
                            HazÄ±r bekleniyor...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedFiles = [];

    // --- SÃœRÃœKLE BIRAK AYARLARI ---
    const dropArea = document.getElementById('dropArea');

    // 1. Dosya alanÄ±n Ã¼zerine gelince (GÃ¶rsel efekt iÃ§in)
    dropArea.addEventListener('dragover', (event) => {
        event.preventDefault(); // VarsayÄ±lanÄ± engelle (DosyayÄ± tarayÄ±cÄ±da aÃ§masÄ±n)
        dropArea.classList.add('dragover');
    });

    // 2. Dosya alanÄ±n Ã¼zerinden Ã§Ä±kÄ±nca
    dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('dragover');
    });

    // 3. Dosya bÄ±rakÄ±lÄ±nca
    dropArea.addEventListener('drop', (event) => {
        event.preventDefault();
        dropArea.classList.remove('dragover');
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
            handleFiles(files);
        }
    });
    // -----------------------------

    function log(message, color="black") {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        logArea.innerHTML += `<div class="log-entry" style="color:${color}">[${time}] ${message}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function handleFiles(files) {
        selectedFiles = files; // DosyalarÄ± global deÄŸiÅŸkene ata
        if (files.length > 0) {
            document.getElementById('processBtn').classList.remove('disabled');
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileInfo').innerText = `${files.length} adet dosya kuyrukta.`;
            log(`${files.length} adet dosya seÃ§ildi/bÄ±rakÄ±ldÄ±.`, "#0d6efd");
        }
    }

    async function processFiles() {
        if (selectedFiles.length === 0) return;

        const zip = new JSZip();
        const processBtn = document.getElementById('processBtn');
        processBtn.classList.add('disabled');
        processBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ä°ÅŸleniyor...`;

        log("--- Ä°ÅŸlem BaÅŸlatÄ±lÄ±yor ---", "black");

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            
            try {
                const arrayBuffer = await file.arrayBuffer();

                // ----------------------------------------------------------------
                // ADIM 1: SHEETJS ile VERÄ° OKUMA VE TEMÄ°Z LÄ°STE OLUÅžTURMA
                // ----------------------------------------------------------------
                const workbookReader = XLSX.read(arrayBuffer);
                let sheetName = "Sayfa1";
                if (!workbookReader.Sheets[sheetName]) {
                    sheetName = workbookReader.SheetNames[0]; 
                }
                const sheet = workbookReader.Sheets[sheetName];

                const istifNoCell = sheet['D5'];
                const istifNoStr = istifNoCell ? String(istifNoCell.v) : "BilinmeyenIstif";

                const caplar = [];
                for (let r = 9; r <= 97; r++) {
                    const cell = sheet['B' + r];
                    caplar.push(cell ? cell.v : 0);
                }

                const dataColumns = ['C', 'E', 'G', 'I', 'K', 'M', 'O'];
                let orbisData = [];
                
                orbisData.push(["istifNo", "cap", "boy", "adet"]);

                dataColumns.forEach(col => {
                    const boyCell = sheet[col + '7'];
                    const boy = boyCell ? boyCell.v : 0;

                    for (let r = 0; r < 89; r++) { 
                        const rowNum = r + 9;
                        const adetCell = sheet[col + rowNum];
                        const adet = adetCell ? adetCell.v : 0;
                        const cap = caplar[r]; 

                        if (adet && adet > 0) {
                            // --- SAYI FORMATI KONTROLÃœ ---
                            let istifVal = istifNoStr;
                            if (!isNaN(istifVal) && istifVal.trim() !== "") {
                                istifVal = Number(istifVal);
                            }
                            // -----------------------------

                            orbisData.push([istifVal, cap, boy, adet]);
                        }
                    }
                });

                const wbOrbis = XLSX.utils.book_new();
                const wsOrbis = XLSX.utils.aoa_to_sheet(orbisData);
                wsOrbis['!cols'] = [{wch:15}, {wch:10}, {wch:10}, {wch:10}];
                XLSX.utils.book_append_sheet(wbOrbis, wsOrbis, "istifEbatExcel");
                const orbisBuffer = XLSX.write(wbOrbis, { bookType: 'xlsx', type: 'array' });
                
                zip.file(`${istifNoStr}.xlsx`, orbisBuffer);


                // ----------------------------------------------------------------
                // ADIM 2: EXCELJS ile STÄ°L KORUYARAK KOPYALAMA
                // ----------------------------------------------------------------
                const workbookStyler = new ExcelJS.Workbook();
                await workbookStyler.xlsx.load(arrayBuffer);

                let sheetToKeep = workbookStyler.getWorksheet("Sayfa1");
                if (!sheetToKeep) {
                    sheetToKeep = workbookStyler.worksheets[0];
                }

                const sheetsToDelete = [];
                workbookStyler.eachSheet((worksheet, sheetId) => {
                    if (worksheet.name !== sheetToKeep.name) {
                        sheetsToDelete.push(sheetId);
                    }
                });

                sheetsToDelete.forEach(id => {
                    workbookStyler.removeWorksheet(id);
                });

                const ebatBuffer = await workbookStyler.xlsx.writeBuffer();

                zip.file(`${istifNoStr}ebat.xlsx`, ebatBuffer);

                log(`âœ… ${file.name} tamamlandÄ±. (Ä°stif: ${istifNoStr})`, "green");

            } catch (err) {
                log(`âŒ Hata (${file.name}): ${err.message}`, "red");
                console.error(err);
            }
        }

        log("ðŸ“¦ ZIP oluÅŸturuluyor...", "#ffc107");

        zip.generateAsync({ type: "blob" }).then(function(content) {
            saveAs(content, "Istif_Raporlari_Pro.zip");
            log("ðŸŽ‰ Ä°ndirme TamamlandÄ±!", "green");
            processBtn.innerHTML = "Ä°ÅŸlem TamamlandÄ±";
            processBtn.classList.remove('btn-primary', 'disabled');
            processBtn.classList.add('btn-success');
            
            setTimeout(() => {
                processBtn.innerText = "ðŸš€ DÃ¶nÃ¼ÅŸtÃ¼rmeyi BaÅŸlat";
                processBtn.classList.remove('btn-success');
                processBtn.classList.add('btn-primary');
            }, 5000);
        });
    }
</script>

</body>
</html>